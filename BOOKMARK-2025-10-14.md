# Project Bookmark - October 14-16, 2025

## Summary
Completed Phase 1 data enrichment: Updated Strunz classifications in Neon database and generated clean CSV exports for e-rocks import with Unicode formulas.

**UPDATE October 16, 2025:** Refreshed 69 incomplete NEW_MINERALS records from Mindat API, updated Neon database, and regenerated import-ready CSVs with proper Class field handling.

---

## CRITICAL IMPORT/EXPORT RULES ⚠️

### E-Rocks Import Rules (MUST FOLLOW)
1. **DO NOT overwrite Titles** - e-rocks node titles are authoritative
2. **Unique Identifiers:**
   - e-rocks node ID (nid) - unique per e-rocks database
   - Mindat ID - unique per mineral, used for matching
3. **NEW_MINERALS criteria:**
   - Only minerals with IMA status: APPROVED, PENDING_PUBLICATION, GRANDFATHERED
   - NOT DISCREDITED, QUESTIONABLE (unless linked to valid replacement)
4. **Class Field Rules:**
   - `entry_type_text = 'mineral'` → Class = "Mineral"
   - `entry_type_text = 'grouplist'` → Class = "Mineral Group"
   - Other entry types → Class = "" (empty)
5. **Strunz Classification Rules:**
   - Must NOT output "0.00.x" or similar invalid codes
   - If strunz10ed1 = '0' → treat as NULL (no output)
   - Use 'x' placeholder for incomplete codes: "9.BG.x" not "9.BG"
6. **Hardness (Mohs) Values:**
   - Store NULL for missing values (NOT zero)
   - Zero (0) is a valid hardness value (e.g., talc)
   - Empty/missing data → NULL
7. **Formula Format:**
   - MUST be Unicode (subscripts, superscripts)
   - NO HTML tags in final export
   - Run `convert-formula-to-unicode.ts` after any export
8. **CSV Import Mode:**
   - Import is in "Replace" mode
   - MUST include ALL 26 columns to prevent data deletion
   - Missing columns will DELETE existing data in e-rocks

### Data Update Scope
- **NEW_MINERALS updates:** Only approved/pending IMA status minerals
- **Other Mindat matches:** Can update any e-rocks record matched to Mindat ID
- **Non-minerals:** Skip Groups, Rocks, Fossils, etc. (unless specific update needed)

---

## What Was Completed Today

### 1. Strunz Classification Cleanup & Enhancement

#### Fixed Invalid Strunz Data
- **Cleaned 5,350 minerals** with zero-value Strunz entries (0.0.0.0 → NULL)
- Script: `npm run clean-fix-strunz`
- Output: `/tmp/strunz-fix/cleaned_minerals.csv`

#### Updated Incomplete Strunz Classifications
- **Fixed 36 minerals** with incomplete Strunz by fetching from Mindat API
  - 35 via ID lookup
  - 1 via name search (worked around 500 errors)
- Scripts:
  - `npm run fix-strunz` (main)
  - `npm run fix-strunz-by-name` (retry 500 errors)

#### Added Placeholder for 3-Part Classifications
- **Updated 595 minerals** with pattern `#.nn.[null]` → `#.nn.x`
- Purpose: Enable search discrimination between classification levels
- Excluded: Groups (name contains "group")
- Script: `npm run add-strunz-placeholder`
- Verified: All updates confirmed in Neon database

**Database:** `mindat_minerals` table in Neon PostgreSQL
**Connection:** Environment variable `DATABASE_URL` in `.env`

---

### 2. E-Rocks Data Enrichment

#### Source Data
- **Input:** `C:\Users\halwh\Downloads\minerals (3).csv`
- **Total records:** 9,040
  - 8,958 minerals
  - 82 non-minerals (skipped)

#### Enrichment Process
- **Script:** `npm run enrich-erocks`
- **Duration:** 22 minutes (1,322 seconds)
- **Matching Strategy:**
  1. Exact Mindat ID matches: 7,763
  2. Exact name matches: 878
  3. Fuzzy matches: 0
  4. Formula matches: 0

#### Results
- **Total matched:** 8,641 minerals (96.5% success)
- **Unmatched:** 317 minerals (EXCEPTIONS)
- **Conflicts flagged:** 235 minerals
- **Varieties identified:** 1,978
- **Synonyms identified:** 146

#### Data Enriched From Mindat
- Mindat IDs and URLs
- Updated Strunz classifications (with `.x` placeholders)
- Crystal system, hardness, streak, tenacity, colour
- Type locality
- Relationships (variety of, synonym of, polymorph of, etc.)
- Mindat status (APPROVED/DISCREDITED)
- Chemical formulas (HTML format)

---

### 3. New Minerals Processing

#### Discovered New Minerals
- **Found:** 424 minerals in Mindat not present in e-rocks
- **Output:** `mindat_NEW_MINERALS.csv`

#### Filtered Discredited Minerals
- **Script:** `npm run filter-discredited`
- **Removed:** 161 discredited minerals
- **Approved:** 263 minerals
- **Output:** `mindat_NEW_MINERALS_FINAL.csv`

---

### 4. Formula Conversion to Unicode

#### What Was Converted
All chemical formulas converted from HTML entities to Unicode characters:

**Subscripts:**
- `<sub>0</sub>` → `₀`
- `<sub>1</sub>` → `₁`
- `<sub>2</sub>` → `₂` (etc.)

**Superscripts:**
- `<sup>+</sup>` → `⁺`
- `<sup>-</sup>` → `⁻`
- `<sup>2+</sup>` → `²⁺`
- `<sup>4+</sup>` → `⁴⁺` (etc.)

**Special Characters:**
- `&middot;` / `&#183;` → `·` (middot)
- `&#9723;` / `□` / `◻` → `☐` (structural vacancy/box)
- `&alpha;` → `α`
- `&beta;` → `β`
- All numeric HTML entities (decimal and hex)

#### Files Converted
1. **`erocks_UPDATE.csv`** - 5,617 formulas converted (65% of 8,641 records)
2. **`mindat_NEW_MINERALS_FINAL.csv`** - 197 formulas converted (75% of 263 records)
3. **`mindat_NEW_MINERALS_FINAL_TEST.csv`** - Test copy with same conversions

**Script:** `npm run convert-formula`

**Examples:**
- `Pb<sub>2</sub>(Te<sup>4+</sup>O<sub>3</sub>)(SO<sub>4</sub>)` → `Pb₂(Te⁴⁺O₃)(SO₄)`
- `&#9723;(Mn²⁺₂Al)Al₆(Si₆O₁₈)(BO₃)₃(OH)₃(OH)` → `☐(Mn²⁺₂Al)Al₆(Si₆O₁₈)(BO₃)₃(OH)₃(OH)`
- `[(NH<sub>4</sub>)<sub>2</sub>Mg<sub>2</sub>(H<sub>2</sub>O)<sub>20</sub>] &middot; [V<sub>10</sub>O<sub>28</sub>]` → `[(NH₄)₂Mg₂(H₂O)₂₀] · [V₁₀O₂₈]`

---

## Final Output Files

### Location: `/tmp/phase1-enrichment/` (accessible via `\\wsl$\Ubuntu\tmp\phase1-enrichment`)

#### Ready for Import

1. **`erocks_UPDATE.csv`** (3.3M, 8,641 records)
   - Existing e-rocks minerals enriched with Mindat data
   - Formulas converted to Unicode
   - Updated Strunz classifications
   - Ready to UPDATE existing e-rocks records

2. **`mindat_NEW_MINERALS_FINAL.csv`** (91K, 263 records)
   - New approved minerals from Mindat
   - Discredited minerals removed (161 filtered out)
   - Formulas converted to Unicode
   - Ready to INSERT as new e-rocks records

3. **`mindat_NEW_MINERALS_FINAL_TEST.csv`** (91K, 263 records)
   - Test copy of final new minerals
   - Identical to FINAL version

#### Reference/Review Files

4. **`erocks_EXCEPTIONS.csv`** (158K, 317 records)
   - E-rocks minerals not found in Mindat
   - May need manual review/matching

5. **`erocks_SKIPPED.csv`** (17K, 82 records)
   - Non-mineral records from e-rocks export

6. **`match_report.json`** (609 bytes)
   - Detailed matching statistics

---

## Scripts Created/Updated

### Strunz Cleanup Scripts
1. **`scripts/clean-and-fix-strunz.ts`**
   - Cleans invalid Strunz data (0.0.0.0)
   - Fetches complete Strunz from Mindat API
   - Command: `npm run clean-fix-strunz`

2. **`scripts/fix-strunz-by-name.ts`**
   - Retries 500 errors using name search
   - Command: `npm run fix-strunz-by-name`

3. **`scripts/add-strunz-placeholder.ts`**
   - Adds `.x` to 3-part Strunz classifications
   - Command: `npm run add-strunz-placeholder`

4. **`scripts/verify-strunz-update.ts`**
   - Verifies Strunz updates in database
   - Command: `npx tsx scripts/verify-strunz-update.ts`

### Data Processing Scripts
5. **`scripts/enrich-erocks-data.ts`** (existing, used)
   - Main enrichment script
   - Matches e-rocks with Mindat database
   - Command: `npm run enrich-erocks <input-csv> [output-dir]`

6. **`scripts/filter-discredited-minerals.ts`**
   - Filters out discredited minerals
   - Command: `npm run filter-discredited`

7. **`scripts/convert-formula-to-unicode.ts`**
   - Converts HTML formulas to Unicode
   - Handles subscripts, superscripts, special chars
   - Converts ALL numeric HTML entities (decimal/hex)
   - Command: `npm run convert-formula [input] [output]`
   - Default: Processes both FINAL files

---

## Database Information

### Neon PostgreSQL Database
- **Table:** `mindat_minerals`
- **Connection:** `DATABASE_URL` in `.env` file
- **Location:** `ep-polished-wave-adxgml16-pooler.c-2.us-east-1.aws.neon.tech`

### Strunz Column Structure
- `strunz10ed1` - Class (e.g., "7")
- `strunz10ed2` - Division (e.g., "BC")
- `strunz10ed3` - Family (e.g., "" or specific code)
- `strunz10ed4` - Specific mineral (e.g., "05" or "x" for placeholder)

### Current Database State
- ✅ 5,350 minerals with invalid Strunz cleaned
- ✅ 36 minerals with incomplete Strunz updated from API
- ✅ 595 minerals with `.x` placeholder added
- ✅ All updates verified in database

---

## Next Steps / TODO

### Import to E-Rocks Drupal
1. Import `erocks_UPDATE.csv` to update existing mineral records
2. Import `mindat_NEW_MINERALS_FINAL.csv` to add new minerals
3. Review `erocks_EXCEPTIONS.csv` for manual matching

### Potential Improvements
- Review 235 minerals with conflicts flagged
- Investigate 317 unmatched minerals in EXCEPTIONS
- Consider fuzzy matching strategies for EXCEPTIONS
- Add more special character mappings if needed

### Data Quality
- All formulas now in consistent Unicode format
- Strunz classifications complete and standardized
- Box (☐) symbols properly represent structural vacancies
- Middot (·) symbols properly represent hydration

---

## Commands Quick Reference

```bash
# Strunz cleanup and fixes
npm run clean-fix-strunz                    # Clean invalid Strunz data
npm run fix-strunz                          # Fix incomplete Strunz from API
npm run fix-strunz-by-name                  # Retry failed API lookups by name
npm run add-strunz-placeholder              # Add .x to 3-part classifications
npx tsx scripts/verify-strunz-update.ts     # Verify database updates

# Data enrichment
npm run enrich-erocks "<input-csv>" [output-dir]  # Enrich e-rocks data

# Post-processing
npm run filter-discredited                  # Remove discredited minerals
npm run convert-formula [input] [output]    # Convert formulas to Unicode

# Testing
npm run add-strunz-placeholder -- --dry-run # Preview changes
```

---

## File Locations

### Project Directory
`/home/halwh/MineralSearch/`

### Output Files
`/tmp/phase1-enrichment/`
- Accessible from Windows: `\\wsl$\Ubuntu\tmp\phase1-enrichment`

### Scripts
`/home/halwh/MineralSearch/scripts/`

### Environment
`.env` file in project root with `DATABASE_URL`

---

## Technical Notes

### CSV Handling
- All CSVs use UTF-8 with BOM
- Quoted fields for safety
- Formula column now contains pure Unicode (no HTML)

### Formula Conversion Details
- Handles nested subscripts/superscripts
- Converts all numeric entities: `&#9723;`, `&#183;`, etc.
- Converts hex entities: `&#xB7;`, `&#x25FB;`, etc.
- Named entities: `&middot;`, `&alpha;`, `&beta;`, etc.
- Strips remaining HTML tags after conversion

### Database Table
- Table: `mindat_minerals` (NOT `minerals`)
- Strunz columns store individual parts as strings
- Empty/null/zero values handled consistently

---

## Statistics Summary

### Strunz Updates (Neon Database)
- Cleaned: 5,350 minerals
- Fixed from API: 36 minerals
- Placeholder added: 595 minerals
- **Total affected: 5,981 minerals**

### E-Rocks Enrichment
- Input: 8,958 minerals
- Matched: 8,641 (96.5%)
- Unmatched: 317 (3.5%)
- Conflicts: 235

### New Minerals
- Discovered: 424
- Approved: 263
- Discredited: 161

### Formula Conversions
- erocks_UPDATE.csv: 5,617 / 8,641 (65%)
- mindat_NEW_MINERALS_FINAL.csv: 197 / 263 (75%)
- **Total formulas converted: 5,814**

---

## Contact & Support

### Mindat API
- Base URL: `https://api.mindat.org/`
- API Key: Stored in `.env` as `MINDAT_API_KEY`
- Rate limit: ~1 request per second (handled by script)

### Known Issues
- Some Mindat minerals return 500 errors (API issue)
- Name search workaround implemented for these cases
- ~594 minerals have incomplete Strunz in Mindat itself

---

## October 16, 2025 - NEW_MINERALS Refresh

### Problem Identified
- 69 NEW_MINERALS records had missing formula or strunz data
- Needed to fetch fresh data from Mindat API
- Update both Neon database AND CSV files for e-rocks import

### Scripts Created

1. **`scripts/refresh-incomplete-minerals.ts`**
   - Scans NEW_MINERALS CSV for missing formula/strunz
   - Fetches updated data from Mindat API
   - Updates Neon database with fresh data
   - Command: `npx tsx scripts/refresh-incomplete-minerals.ts`
   - Result: 69 records identified, 68 updated successfully, 1 temporary API error

2. **`scripts/export-new-minerals-from-neon.ts`**
   - Exports NEW_MINERALS from Neon with proper field handling
   - Concatenates strunz fields: strunz10ed1 + strunz10ed2 + strunz10ed3 + strunz10ed4
   - Applies 'x' placeholder for incomplete strunz
   - Sets Class field based on entry_type_text
   - Filters out invalid "0.00.x" strunz codes
   - Command: `npx tsx scripts/export-new-minerals-from-neon.ts`

3. **`scripts/update-mineral-from-api.ts`**
   - Single mineral update from Mindat API
   - Used to fix Huanghoite-(Nd) after temporary API error
   - Command: `npx tsx scripts/update-mineral-from-api.ts <mindat-id>`

### Key Technical Fixes

1. **Strunz Concatenation Logic:**
   ```sql
   CASE
     WHEN strunz10ed1 IS NOT NULL AND strunz10ed1 != '0' AND strunz10ed2 IS NOT NULL AND strunz10ed3 IS NOT NULL AND strunz10ed4 IS NOT NULL
     THEN strunz10ed1 || '.' || strunz10ed2 || strunz10ed3 || '.' || strunz10ed4
     WHEN strunz10ed1 IS NOT NULL AND strunz10ed1 != '0' AND strunz10ed2 IS NOT NULL AND strunz10ed3 IS NOT NULL
     THEN strunz10ed1 || '.' || strunz10ed2 || strunz10ed3 || '.x'
     WHEN strunz10ed1 IS NOT NULL AND strunz10ed1 != '0' AND strunz10ed2 IS NOT NULL
     THEN strunz10ed1 || '.' || strunz10ed2 || 'x'
     WHEN strunz10ed1 IS NOT NULL AND strunz10ed1 != '0'
     THEN strunz10ed1
     ELSE NULL
   END
   ```

2. **Class Field Logic:**
   ```typescript
   'Class': neon.entry_type_text === 'mineral' ? 'Mineral' :
            (neon.entry_type_text === 'grouplist' ? 'Mineral Group' :
            (orig.Class || ''))
   ```

3. **Invalid Strunz Filter:**
   - Treats strunz10ed1 = '0' as NULL
   - Prevents output of "0.00.x" codes
   - Falls back to original value if no valid Neon data

### Processing Pipeline

```bash
# Step 1: Export from Neon with concatenated strunz
npx tsx scripts/export-new-minerals-from-neon.ts

# Step 2: Convert HTML formulas to Unicode
npm run convert-formula /tmp/phase1-enrichment/mindat_NEW_MINERALS_FROM_NEON.csv /tmp/phase1-enrichment/mindat_NEW_MINERALS_FINAL_FIXED.csv

# Step 3: Create test file
head -6 /tmp/phase1-enrichment/mindat_NEW_MINERALS_FINAL_FIXED.csv > /tmp/phase1-enrichment/mindat_NEW_MINERALS_FINAL_FIXED_TEST.csv
```

### Final Output Files (October 16)

- **`mindat_NEW_MINERALS_FINAL_FIXED.csv`** (263 records)
  - All 69 refreshed records with updated formula/strunz
  - Unicode formulas (no HTML)
  - Valid strunz codes only (no "0.00.x")
  - Approval status = "Approved" for all
  - Class = "Mineral" for minerals, "Mineral Group" for groups
  - All 26 columns preserved

- **`mindat_NEW_MINERALS_FINAL_FIXED_TEST.csv`** (5 records)
  - Test file for safe import verification
  - Same format as full file

### Lessons Learned

1. **Context/Memory Issues:**
   - Must document all rules and conventions
   - Repeated mistakes with strunz placeholders, Class field, formula format
   - This bookmark file is CRITICAL for future work

2. **Neon Database Structure:**
   - Strunz stored in 4 separate columns, must concatenate
   - entry_type_text determines Class value
   - ima_formula preferred, fall back to mindat_formula

3. **CSV Import Behavior:**
   - e-rocks import is in "Replace" mode
   - Missing columns will DELETE existing data
   - Always include ALL 26 columns

4. **API Reliability:**
   - Mindat API occasionally returns 500 errors
   - Retry mechanism or manual fix needed
   - Not all minerals have complete data in Mindat

### Statistics (October 16 Update)

- **Records scanned:** 263 NEW_MINERALS
- **Incomplete records found:** 69
- **Successfully updated:** 68
- **API errors:** 1 (fixed manually)
- **Formulas converted:** 237
- **Groups identified:** 18 (Class = "Mineral Group")
- **Invalid strunz removed:** 18 ("0.00.x" codes)

---

**End of Bookmark - October 14-16, 2025**
